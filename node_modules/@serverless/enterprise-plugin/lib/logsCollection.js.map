{"version":3,"sources":["../../lib/logsCollection.js"],"names":["chalk","require","inspect","pickResourceType","upperFirst","API_GATEWAY_FILTER_PATTERN","API_GATEWAY_V2_FILTER_PATTERN","LAMBDA_FILTER_PATTERN","getAccessKeyForTenant","getLogDestination","module","exports","ctx","sls","service","custom","enterprise","collectLambdaLogs","cli","log","logIngestMode","template","provider","compiledCloudFormationTemplate","logGroups","length","accessKey","org","request","Account","destinationOpts","appUid","tenantUid","orgUid","serviceName","getServiceName","stageName","getStage","regionName","getRegion","accountId","destinationArn","e","message","includes","keyword","Error","Object","keys","logGroupIndex","logGroupKey","key","logGroupName","resource","Properties","LogGroupName","join","filterPattern","startsWith","Resources","Type","DestinationArn","FilterPattern","Ref"],"mappings":"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","sourcesContent":["'use strict';\n\nconst chalk = require('chalk');\nconst { inspect } = require('util');\n\n/*\n * Logs Collection\n * - Collects `SERVERLESS PLATFORM || REPORT` from lambda logs\n * - Collects `sls-access-logs` from API Gateway access logs\n */\n\nconst {\n  pickResourceType,\n  upperFirst,\n  API_GATEWAY_FILTER_PATTERN,\n  API_GATEWAY_V2_FILTER_PATTERN,\n  LAMBDA_FILTER_PATTERN,\n} = require('./utils');\n\nconst { getAccessKeyForTenant, getLogDestination } = require('@serverless/platform-sdk');\n\nmodule.exports = async (ctx) => {\n  if (\n    ctx.sls.service.custom &&\n    ctx.sls.service.custom.enterprise &&\n    ctx.sls.service.custom.enterprise.collectLambdaLogs === false\n  ) {\n    ctx.sls.cli.log('Info: This plugin is not configured to collect AWS Lambda Logs.');\n    return;\n  }\n\n  if (\n    ctx.sls.service.custom &&\n    ctx.sls.service.custom.enterprise &&\n    ctx.sls.service.custom.enterprise.logIngestMode === 'pull'\n  ) {\n    ctx.sls.cli.log('Info: Log ingestion is configured to pull-based ingestion.');\n    return;\n  }\n\n  const template = ctx.sls.service.provider.compiledCloudFormationTemplate;\n\n  // Gather possible targets\n  const logGroups = pickResourceType(template, 'AWS::Logs::LogGroup');\n  if (logGroups.length === 0) {\n    return;\n  }\n\n  const accessKey = await getAccessKeyForTenant(ctx.sls.service.org);\n  const { Account } = await ctx.provider.request('STS', 'getCallerIdentity', {});\n  const destinationOpts = {\n    accessKey,\n    appUid: ctx.sls.service.appUid,\n    tenantUid: ctx.sls.service.orgUid,\n    serviceName: ctx.sls.service.getServiceName(),\n    stageName: ctx.provider.getStage(),\n    regionName: ctx.provider.getRegion(),\n    accountId: Account,\n  };\n\n  let destinationArn;\n\n  try {\n    ({ destinationArn } = await getLogDestination(destinationOpts));\n  } catch (e) {\n    if (e.message && e.message.includes('not supported in region')) {\n      ctx.sls.cli.log(\n        chalk.keyword('orange')(\n          `Warning: Lambda log collection is not supported in ${ctx.provider.getRegion()}`\n        )\n      );\n      return;\n    }\n    throw new Error(e.message);\n  }\n\n  // For each log group, set up subscription\n  for (const logGroupIndex of Object.keys(logGroups)) {\n    const logGroupKey = logGroups[logGroupIndex].key;\n    let logGroupName = logGroups[logGroupIndex].resource.Properties.LogGroupName;\n\n    if (typeof logGroupName !== 'string') {\n      if (!logGroupName || !logGroupName['Fn::Join']) {\n        throw new Error(\n          `Unable to resolve '${logGroupIndex}' log group name out of: ${inspect(\n            logGroups[logGroupIndex].resource.Properties\n          )}`\n        );\n      }\n      if (logGroupName['Fn::Join']) {\n        logGroupName = logGroupName['Fn::Join'][1].join(logGroupName['Fn::Join'][0]);\n      } else {\n        continue;\n      }\n    }\n\n    let filterPattern = LAMBDA_FILTER_PATTERN;\n    if (logGroupName.startsWith('/aws/api-gateway/')) {\n      filterPattern = API_GATEWAY_FILTER_PATTERN;\n    } else if (logGroupName.startsWith('/aws/http-api/')) {\n      filterPattern = API_GATEWAY_V2_FILTER_PATTERN;\n    }\n\n    template.Resources[`CloudWatchLogsSubscriptionFilter${upperFirst(logGroupKey)}`] = {\n      Type: 'AWS::Logs::SubscriptionFilter',\n      Properties: {\n        DestinationArn: destinationArn,\n        FilterPattern: filterPattern,\n        LogGroupName: {\n          Ref: logGroupKey,\n        },\n      },\n    };\n  }\n};\n"],"file":"logsCollection.js"}