{"version":3,"sources":["../../../../lib/safeguards/policies/require-dlq.js"],"names":["require","entries","fromPairs","asyncEvents","Set","module","exports","dlqPolicy","policy","service","failed","functions","declaration","naming","provider","Resources","compiled","logicalFuncNamesToConfigFuncName","Object","keys","map","funcName","getLambdaLogicalId","customResourceFuncIdentifier","Properties","Type","DeadLetterConfig","TargetArn","FunctionName","includes","events","eventTypes","ev","eventIntersection","filter","x","has","length","size","fail","approve","docs"],"mappings":"AAAA;;;;;;;;;;;;;;;;iBAE+BA,OAAO,CAAC,QAAD,C;MAA9BC,O,YAAAA,O;MAASC,S,YAAAA,S;;AAEjB,MAAMC,WAAW,GAAG,IAAIC,GAAJ,CAAQ,CAC1B,IAD0B,EAE1B,KAF0B,EAG1B,YAH0B,EAI1B,KAJ0B,EAK1B,iBAL0B,EAM1B,eAN0B,EAO1B,iBAP0B,EAQ1B,gBAR0B,CAAR,CAApB;;AAUAC,MAAM,CAACC,OAAP,GAAiB,SAASC,SAAT,CAAmBC,MAAnB,EAA2BC,OAA3B,EAAoC;AACnD,MAAIC,MAAM,GAAG,KAAb;AADmD,QAGlCC,SAHkC,GAQ/CF,OAR+C,CAGjDG,WAHiD,CAGlCD,SAHkC;AAAA,QAIrCE,MAJqC,GAQ/CJ,OAR+C,CAIjDK,QAJiD,CAIrCD,MAJqC;AAAA,QAMAE,SANA,GAQ/CN,OAR+C,CAKjDO,QALiD,CAM/C,2CAN+C,EAMAD,SANA;AASnD,QAAME,gCAAgC,GAAGf,SAAS,CAChDgB,MAAM,CAACC,IAAP,CAAYR,SAAS,IAAI,EAAzB,EAA6BS,GAA7B,CAAkCC,QAAD,IAAc,CAACR,MAAM,CAACS,kBAAP,CAA0BD,QAA1B,CAAD,EAAsCA,QAAtC,CAA/C,CADgD,CAAlD;AAIA,QAAME,4BAA4B,GAAG,kBAArC,CAbmD,CAenD;;AAfmD,6CAgBJtB,OAAO,CAACc,SAAD,CAhBH;AAAA;;AAAA;AAgBnD,wDAAmE;AAAA;AAAA,YAAvDM,QAAuD;AAAA;AAAA,YAA3CG,UAA2C,gBAA3CA,UAA2C;AAAA,YAA/BC,IAA+B,gBAA/BA,IAA+B;;AACjE,UACEA,IAAI,KAAK,uBAAT,IACCD,UAAU,CAACE,gBAAX,IAA+BF,UAAU,CAACE,gBAAX,CAA4BC,SAF9D,EAGE;AACA;AACD,OANgE,CAQjE;;;AACA,UAAIH,UAAU,CAACI,YAAX,CAAwBC,QAAxB,CAAiCN,4BAAjC,CAAJ,EAAoE;AAEpE,YAAMO,MAAM,GAAG,CAACnB,SAAS,CAACM,gCAAgC,CAACI,QAAD,CAAjC,CAAT,IAAyD,EAA1D,EAA8DS,MAA9D,IAAwE,EAAvF;AACA,YAAMC,UAAU,GAAG,IAAI3B,GAAJ,CAAQ0B,MAAM,CAACV,GAAP,CAAYY,EAAD,IAAQd,MAAM,CAACC,IAAP,CAAYa,EAAZ,EAAgB,CAAhB,CAAnB,CAAR,CAAnB;AACA,YAAMC,iBAAiB,GAAG,IAAI7B,GAAJ,CAAQ,CAAC,GAAGD,WAAJ,EAAiB+B,MAAjB,CAAyBC,CAAD,IAAOJ,UAAU,CAACK,GAAX,CAAeD,CAAf,CAA/B,CAAR,CAA1B;;AACA,UAAIL,MAAM,CAACO,MAAP,KAAkB,CAAlB,IAAuBJ,iBAAiB,CAACK,IAAlB,GAAyB,CAApD,EAAuD;AACrD5B,QAAAA,MAAM,GAAG,IAAT;AACAF,QAAAA,MAAM,CAAC+B,IAAP,CACG,aACCtB,gCAAgC,CAACI,QAAD,CAAhC,IAA8CA,QAC/C,gDAHH;AAKD;AACF;AAtCkD;AAAA;AAAA;AAAA;AAAA;;AAwCnD,MAAI,CAACX,MAAL,EAAa;AACXF,IAAAA,MAAM,CAACgC,OAAP;AACD;AACF,CA3CD;;AA6CAnC,MAAM,CAACC,OAAP,CAAemC,IAAf,GAAsB,+BAAtB","sourcesContent":["'use strict';\n\nconst { entries, fromPairs } = require('lodash');\n\nconst asyncEvents = new Set([\n  's3',\n  'sns',\n  'alexaSkill',\n  'iot',\n  'cloudwatchEvent',\n  'cloudwatchLog',\n  'cognitoUserPool',\n  'alexaSmartHome',\n]);\nmodule.exports = function dlqPolicy(policy, service) {\n  let failed = false;\n  const {\n    declaration: { functions },\n    provider: { naming },\n    compiled: {\n      'cloudformation-template-update-stack.json': { Resources },\n    },\n  } = service;\n  const logicalFuncNamesToConfigFuncName = fromPairs(\n    Object.keys(functions || {}).map((funcName) => [naming.getLambdaLogicalId(funcName), funcName])\n  );\n\n  const customResourceFuncIdentifier = 'custom-resource-';\n\n  // for (const [name, { events, onError }] of entries(functions)) {\n  for (const [funcName, { Properties, Type }] of entries(Resources)) {\n    if (\n      Type !== 'AWS::Lambda::Function' ||\n      (Properties.DeadLetterConfig && Properties.DeadLetterConfig.TargetArn)\n    ) {\n      continue;\n    }\n\n    // ignore functions injected for custom resources by SFO\n    if (Properties.FunctionName.includes(customResourceFuncIdentifier)) continue;\n\n    const events = (functions[logicalFuncNamesToConfigFuncName[funcName]] || {}).events || [];\n    const eventTypes = new Set(events.map((ev) => Object.keys(ev)[0]));\n    const eventIntersection = new Set([...asyncEvents].filter((x) => eventTypes.has(x)));\n    if (events.length === 0 || eventIntersection.size > 0) {\n      failed = true;\n      policy.fail(\n        `Function \"${\n          logicalFuncNamesToConfigFuncName[funcName] || funcName\n        }\" doesn't have a Dead Letter Queue configured.`\n      );\n    }\n  }\n\n  if (!failed) {\n    policy.approve();\n  }\n};\n\nmodule.exports.docs = 'http://slss.io/sg-require-dlq';\n"],"file":"require-dlq.js"}