{"version":3,"sources":["../../lib/wrap.js"],"names":["chalk","require","fs","path","_","JSZip","getAccessKeyForTenant","addTree","writeZip","version","deprecatedNodes","supportedNodeRuntime","runtime","includes","supportedPythonRuntime","supportedRuntime","isDevMode","Boolean","process","env","SLS_DEV_MODE","isLocalInvocation","ctx","commands","sls","processedInput","wrapNodeJs","fn","accessKey","standardHandlerExec","entryOrig","handlerOrig","devModeHandlerExec","newHandlerCode","service","org","app","appUid","orgUid","deploymentUid","get","custom","enterprise","compressLogs","disableAwsSpans","disableHttpSpans","provider","getStage","SERVERLESS_PLATFORM_STAGE","disableFrameworksInstrumentation","name","timeout","writeFileSync","join","config","servicePath","entryNew","wrapPython","wrap","cli","log","keyword","functions","state","unsupportedRuntimes","Set","Object","keys","func","add","stage","entry","handler","split","slice","extension","key","replace","handlerNew","size","Array","from","pathAssets","pathExistsSync","removeSync","ensureDirSync","vals","map","some","pathSdk","resolve","__dirname","pathSdkDest","copySync","zipData","readFile","package","artifact","zip","loadAsync","wrapperData","file","undefined","include","push","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\n/*\n * Wrap\n * - Bundles the ServerlessSDK into your functions\n * - Wraps your function handlers with the ServerlessSDK\n */\n\nconst chalk = require('chalk');\nconst fs = require('fs-extra');\nconst path = require('path');\nconst _ = require('lodash');\nconst JSZip = require('jszip');\nconst { getAccessKeyForTenant } = require('@serverless/platform-sdk');\nconst { addTree, writeZip } = require('./zipTree');\nconst { version } = require('../package.json');\n\nconst deprecatedNodes = ['nodejs', 'nodejs4.3', 'nodejs4.3-edge'];\nconst supportedNodeRuntime = (runtime) =>\n  runtime && runtime.includes('nodejs') && !deprecatedNodes.includes(runtime);\nconst supportedPythonRuntime = (runtime) => runtime && runtime.includes('python');\nconst supportedRuntime = (runtime) =>\n  supportedNodeRuntime(runtime) || supportedPythonRuntime(runtime);\n\nconst isDevMode = Boolean(process.env.SLS_DEV_MODE);\n\nconst isLocalInvocation = (ctx) => {\n  const { commands } = ctx.sls.processedInput;\n  return commands[0] === 'invoke' && commands[1] === 'local';\n};\n\n/*\n * Wrap Node.js Functions\n */\nconst wrapNodeJs = (fn, ctx, accessKey) => {\n  const standardHandlerExec = `\ntry {\n  const userHandler = require('./${fn.entryOrig}.js');\n  module.exports.handler = serverlessSDK.handler(userHandler.${fn.handlerOrig}, handlerWrapperArgs);\n} catch (error) {\n  module.exports.handler = serverlessSDK.handler(() => { throw error }, handlerWrapperArgs);\n}`;\n\n  /**\n   * If you're in \"dev mode\" export a slightly different wrapped handler. Basically, we need to:\n   *\n   * 1. Establish a connection to the websocket so we can collect logs and metrics\n   * 2. import the user handler AFTER the websocket is connected so we get logs/errors on loading\n   * 3. Call the user handler\n   * 4. Respect the original return values and bubble those up\n   *\n   * It should be noted that dev mode will ALWAYS return a promise, there is no way around that\n   * because dev mode requires the setup of the web socket which is async.  Additionally, if the\n   * userHandler has a `require('aws-sdk')` the function will timeout UNLESS we have already\n   * required the package from the global context\n   **/\n  const devModeHandlerExec = `\nconst studioHandler = (event, context, callback) => {\n  console.log('Starting serverless Studio');\n  return new Promise((resolve, reject) => {\n\n    // handle callback resolutions since we always return a promise\n    let finalized = false;\n    const finalize = (error, result, isFromCallback) => {\n      if (finalized) { return; }\n      finalized = true;\n      serverlessSDK\n        .publishSync({\n          event: \"studio.invocationInfo\",\n          data: {\n            functionName: process.env.AWS_LAMBDA_FUNCTION_NAME,\n            requestId: context.awsRequestId,\n            transactionId: event.requestContext ? event.requestContext.requestId : null,\n            response: result,\n            error: error\n          }\n        })\n        .catch((err) => {\n          console.log('Unable to send response data to Studio', err);\n        })\n        .finally(() => {\n\t\t\t\t\tserverlessSDK.stopDevMode();\n\t\t\t\t\tif (isFromCallback) callback(error, result);\n          else if (error) reject(error);\n          else resolve(result);\n        });\n    }\n\n    // Patch context methods\n    const contextProxy = new Proxy(context, {\n      get: (target, prop) => {\n        if (prop === 'done') {\n          return (err, res) => {\n            finalize(err, res, true)\n          };\n        } else if (prop === 'succeed') {\n          return res => {\n            finalize(null, res, true);\n          };\n        } else if (prop === 'fail') {\n          return err => {\n            finalize(err, null, true);\n          };\n        }\n        return target[prop];\n      },\n    });\n\n    // Start dev mode\n    serverlessSDK\n      .startDevMode(event, context)\n      .then(() => {\n        try {\n          serverlessSDK.publish({\n            event: \"studio.invocationInfo\",\n            data: {\n              functionName: process.env.AWS_LAMBDA_FUNCTION_NAME,\n              requestId: context.awsRequestId,\n              transactionId: event.requestContext ? event.requestContext.requestId : null,\n              event\n            }\n          });\n        } catch (err) {\n          console.log('Unable to send invocation data to Studio', err);\n        }\n\t\t\t\tconst userHandler = require('./${fn.entryOrig}.js');\n\t\t\t\tlet result;\n        try {\n\t\t\t\t\tresult = serverlessSDK.handler(userHandler.${fn.handlerOrig}, handlerWrapperArgs)(\n\t\t\t\t\t\tevent, contextProxy, (error, result) => finalize(error, result, true)\n\t\t\t\t\t);\n\t\t\t\t} catch (error) {\n          console.log('Error invoking wrapped function', error);\n\t\t\t\t\tfinalize(error, null, true);\n\t\t\t\t\treturn;\n        }\n\t\t\t\t// if a promise was returned, we need to return the resolved promise\n\t\t\t\tif (result && typeof result.then === 'function') {\n\t\t\t\t\tresult.then(res => finalize(null, res), finalize);\n\t\t\t\t}\n      }, (error) => {\n\t\t\t\tconsole.error('Unable to start Studio mode', error);\n\t\t\t\tcallback(error);\n      });\n  });\n};\nmodule.exports.handler = studioHandler`;\n\n  const newHandlerCode = `\nvar serverlessSDK = require('./serverless_sdk/index.js');\nserverlessSDK = new serverlessSDK({\n  orgId: '${ctx.sls.service.org}',\n  applicationName: '${ctx.sls.service.app}',\n  appUid: '${ctx.sls.service.appUid}',\n  orgUid: '${ctx.sls.service.orgUid}',\n  deploymentUid: '${ctx.deploymentUid}',\n  serviceName: '${ctx.sls.service.service}',\n  shouldLogMeta: ${\n    !isLocalInvocation(ctx) &&\n    _.get(ctx.sls.service.custom, ['enterprise', 'collectLambdaLogs']) !== false\n  },\n  shouldCompressLogs: ${\n    !ctx.sls.service.custom ||\n    !ctx.sls.service.custom.enterprise ||\n    ctx.sls.service.custom.enterprise.compressLogs !== false\n  },\n  disableAwsSpans: ${Boolean(\n    ctx.sls.service.custom &&\n      ctx.sls.service.custom.enterprise &&\n      ctx.sls.service.custom.enterprise.disableAwsSpans\n  )},\n  disableHttpSpans: ${Boolean(\n    ctx.sls.service.custom &&\n      ctx.sls.service.custom.enterprise &&\n      ctx.sls.service.custom.enterprise.disableHttpSpans\n  )},\n  stageName: '${ctx.provider.getStage()}',\n  serverlessPlatformStage: '${process.env.SERVERLESS_PLATFORM_STAGE || 'prod'}',\n  devModeEnabled: ${isDevMode},\n  accessKey: ${isDevMode ? `'${accessKey}'` : null},\n  pluginVersion: '${version}',\n  disableFrameworksInstrumentation: ${Boolean(\n    ctx.sls.service.custom &&\n      ctx.sls.service.custom.enterprise &&\n      ctx.sls.service.custom.enterprise.disableFrameworksInstrumentation\n  )}\n});\n\nconst handlerWrapperArgs = { functionName: '${fn.name}', timeout: ${fn.timeout} };\n${isDevMode ? devModeHandlerExec : standardHandlerExec}`;\n\n  // Create new handlers\n  fs.writeFileSync(path.join(ctx.sls.config.servicePath, `${fn.entryNew}.js`), newHandlerCode);\n};\n\n/*\n * Wrap python Functions\n */\nconst wrapPython = (fn, ctx) => {\n  const newHandlerCode = `import serverless_sdk\nsdk = serverless_sdk.SDK(\n    org_id='${ctx.sls.service.org}',\n    application_name='${ctx.sls.service.app}',\n    app_uid='${ctx.sls.service.appUid}',\n    org_uid='${ctx.sls.service.orgUid}',\n    deployment_uid='${ctx.deploymentUid}',\n    service_name='${ctx.sls.service.service}',\n    should_log_meta=${\n      !isLocalInvocation(ctx) &&\n      _.get(ctx.sls.service.custom, ['enterprise', 'collectLambdaLogs']) !== false\n        ? 'True'\n        : 'False'\n    },\n    should_compress_logs=${\n      !ctx.sls.service.custom ||\n      !ctx.sls.service.custom.enterprise ||\n      ctx.sls.service.custom.enterprise.compressLogs !== false\n        ? 'True'\n        : 'False'\n    },\n    disable_aws_spans=${\n      ctx.sls.service.custom &&\n      ctx.sls.service.custom.enterprise &&\n      ctx.sls.service.custom.enterprise.disableAwsSpans\n        ? 'True'\n        : 'False'\n    },\n    disable_http_spans=${\n      ctx.sls.service.custom &&\n      ctx.sls.service.custom.enterprise &&\n      ctx.sls.service.custom.enterprise.disableHttpSpans\n        ? 'True'\n        : 'False'\n    },\n    stage_name='${ctx.provider.getStage()}',\n    plugin_version='${version}',\n    disable_frameworks_instrumentation=${\n      ctx.sls.service.custom &&\n      ctx.sls.service.custom.enterprise &&\n      ctx.sls.service.custom.enterprise.disableFrameworksInstrumentation\n        ? 'True'\n        : 'False'\n    }\n)\nhandler_wrapper_kwargs = {'function_name': '${fn.name}', 'timeout': ${fn.timeout}}\ntry:\n    user_handler = serverless_sdk.get_user_handler('${fn.entryOrig}.${fn.handlerOrig}')\n    handler = sdk.handler(user_handler, **handler_wrapper_kwargs)\nexcept Exception as error:\n    e = error\n    def error_handler(event, context):\n        raise e\n    handler = sdk.handler(error_handler, **handler_wrapper_kwargs)\n`;\n  // Create new handlers\n  fs.writeFileSync(path.join(ctx.sls.config.servicePath, `${fn.entryNew}.py`), newHandlerCode);\n};\n\nconst wrap = async (ctx) => {\n  // Check if we support the provider\n  if (ctx.sls.service.provider.name !== 'aws') {\n    ctx.sls.cli.log(\n      chalk.keyword('orange')(\n        'Warning: The Serverless Dashboard does not currently support this provider.'\n      )\n    );\n  }\n\n  /*\n   * Prepare Functions\n   */\n  const { functions } = ctx.sls.service;\n  ctx.state.functions = {};\n  const unsupportedRuntimes = new Set();\n  for (const func of Object.keys(functions)) {\n    const runtime = functions[func].runtime\n      ? functions[func].runtime\n      : ctx.sls.service.provider.runtime;\n    if (!supportedRuntime(runtime)) {\n      unsupportedRuntimes.add(runtime);\n      continue;\n    }\n\n    // the default is 6s: https://serverless.com/framework/docs/providers/aws/guide/serverless.yml/\n    const timeout = functions[func].timeout || ctx.sls.service.provider.timeout || 6;\n\n    // Process name\n    let name;\n    if (functions[func].name) {\n      ({ name } = functions[func]);\n    } else {\n      name = `${ctx.sls.service.service}-${ctx.sls.service.provider.stage}-${func}`;\n    }\n\n    // Process handler\n    const entry = functions[func].handler.split('.').slice(0, -1).join('.');\n    const handler = functions[func].handler.split('.').slice(-1)[0];\n    let extension = 'js';\n    if (runtime.includes('python')) {\n      extension = 'py';\n    }\n\n    ctx.state.functions[func] = {\n      key: func,\n      name,\n      runtime,\n      timeout,\n      extension,\n      entryOrig: entry,\n      handlerOrig: handler,\n      entryNew: `s_${func.replace(/-/g, '_')}`,\n      handlerNew: 'handler',\n    };\n  }\n  if (unsupportedRuntimes.size) {\n    ctx.sls.cli.log(\n      chalk.keyword('orange')(\n        `Warning the Serverless Dashboard doesn't support the following runtime${\n          unsupportedRuntimes.size === 1 ? '' : 's'\n        }: ${Array.from(unsupportedRuntimes).join(', ')}`\n      )\n    );\n  }\n\n  /*\n   * Wrap Functions\n   */\n\n  ctx.state.pathAssets = path.join(ctx.sls.config.servicePath, 'serverless_sdk');\n\n  // Clear existing handler dir\n  if (fs.pathExistsSync(ctx.state.pathAssets)) {\n    fs.removeSync(ctx.state.pathAssets);\n  }\n\n  // Create new handler dir\n  fs.ensureDirSync(ctx.state.pathAssets);\n\n  // Copy SDK\n  const vals = Object.keys(ctx.state.functions).map((key) => ctx.state.functions[key]);\n  if (vals.some(({ runtime }) => supportedNodeRuntime(runtime))) {\n    const pathSdk = path.resolve(__dirname, '../sdk-js/dist/index.js');\n    const pathSdkDest = path.join(ctx.state.pathAssets, './index.js');\n    fs.copySync(pathSdk, pathSdkDest);\n  }\n  if (vals.some(({ runtime }) => supportedPythonRuntime(runtime))) {\n    const pathSdk = path.resolve(__dirname, '../sdk-py/serverless_sdk');\n    fs.copySync(pathSdk, ctx.state.pathAssets);\n  }\n\n  // Prepare & Copy Function Handlers\n  for (const fn of Object.keys(ctx.state.functions)) {\n    const func = ctx.state.functions[fn];\n\n    if (!supportedRuntime(func.runtime)) {\n      continue;\n    }\n\n    // Get access key for the platform, but only for dev mode. It's needed\n    // to authenticate to the platform WebSocket during runtime\n    let accessKey = null;\n\n    if (isDevMode) {\n      accessKey = await getAccessKeyForTenant(ctx.sls.service.org);\n    }\n\n    // Add the Serverless SDK wrapper around the function\n\n    if (supportedNodeRuntime(func.runtime)) {\n      wrapNodeJs(func, ctx, accessKey);\n    } else if (supportedPythonRuntime(func.runtime)) {\n      wrapPython(func, ctx);\n    }\n\n    // Re-assign the handler to point to the wrapper\n    ctx.sls.service.functions[fn].handler = `${func.entryNew}.${func.handlerNew}`;\n\n    if (_.get(ctx.sls.service.functions[fn], 'package.artifact')) {\n      const zipData = await fs.readFile(ctx.sls.service.functions[fn].package.artifact);\n      const zip = await JSZip.loadAsync(zipData);\n      const wrapperData = await fs.readFile(\n        path.join(ctx.sls.config.servicePath, `${func.entryNew}.${func.extension}`)\n      );\n      zip.file(`${func.entryNew}.${func.extension}`, wrapperData);\n      await addTree(zip, 'serverless_sdk');\n      await writeZip(zip, ctx.sls.service.functions[fn].package.artifact);\n    } else if (\n      _.get(\n        ctx.sls.service.functions[fn],\n        'package.individually',\n        _.get(ctx.sls.service, 'package.individually', false)\n      )\n    ) {\n      // add include directives for handler file & sdk lib\n      if (ctx.sls.service.functions[fn].package === undefined) {\n        ctx.sls.service.functions[fn].package = {};\n      }\n      if (ctx.sls.service.functions[fn].package.include === undefined) {\n        ctx.sls.service.functions[fn].package.include = [];\n      }\n      ctx.sls.service.functions[fn].package.include.push(`${func.entryNew}.${func.extension}`);\n      ctx.sls.service.functions[fn].package.include.push('serverless_sdk/**');\n    }\n  }\n\n  // add include directives for handler file & sdk lib\n  if (!_.get(ctx.sls.service, 'package.individually', false)) {\n    let extension = 'js';\n    if (supportedPythonRuntime(ctx.sls.service.provider.runtime)) {\n      extension = 'py';\n    }\n    if (ctx.sls.service.package === undefined) {\n      ctx.sls.service.package = {};\n    }\n    if (ctx.sls.service.package.include === undefined) {\n      ctx.sls.service.package.include = [];\n    }\n    ctx.sls.service.package.include.push(`s_*.${extension}`);\n    ctx.sls.service.package.include.push('serverless_sdk/**');\n  }\n};\n\nmodule.exports = wrap;\n"],"file":"wrap.js"}