{"version":3,"sources":["../../../lib/deployment/parse.js"],"names":["fs","require","_","SDK","getServerlessFilePath","simpleGit","packageJsonVersion","version","git","silent","parseDeploymentData","ctx","status","error","archived","service","sls","deployment","Deployment","accountId","provider","getAccountId","serverlessFileName","processedInput","options","config","servicePath","serverlessFile","readFile","toString","cfnStack","request","StackName","naming","getStackName","requestError","providerError","statusCode","logsRoleArn","custom","enterprise","logAccessIamRole","logsRole","find","Stacks","Outputs","OutputKey","OutputValue","logIngestMode","outputs","entries","outputKey","outputValue","startsWith","cfnOutput","slice","set","buildId","process","env","SERVERLESS_BUILD_ID","SLS_BUILD_ID","versionFramework","versionEnterprisePlugin","tenantUid","orgUid","appUid","tenantName","org","appName","app","serviceName","stageName","getStage","regionName","getRegion","deploymentUid","type","aws","layers","plugins","modules","safeguards","state","safeguardsResults","secrets","Array","from","secretsUsed","vcs","SERVERLESS_CI_CD","Object","assign","repository","SERVERLESS_REPO","branch","SERVERLESS_BRANCH","pullRequest","SERVERLESS_PULL_REQUEST","committer","SERVERLESS_COMMIT_USER","commit","SERVERLESS_COMMIT_SHA","commitMessage","SERVERLESS_COMMIT_MSG","deployType","SERVERLESS_DEPLOY_TYPE","relativePath","SERVERLESS_ROOT_PATH","isGit","checkIsRepo","err","current","origin","raw","trim","remotes","getRemotes","originRemote","filter","name","originUrl","refs","fetch","gitShowError","message","includes","committerEmail","keys","functions","fnName","fn","deployedFunctionName","events","setFunction","description","timeout","arn","handler","memorySize","memory","runtime","environment","role","onError","awsKmsKeyArn","tags","vpc","sub","subDetails","apigResource","endsWith","match","getServiceEndpointRegex","apiId","split","path","method","cors","integration","authorizer","restApiId","httpApiId","websocketApiId","setSubscription","function","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\n/*\n * Save Deployment\n * - This uses the new deployment data model.\n */\n\nconst fs = require('fs-extra');\nconst _ = require('lodash');\nconst SDK = require('@serverless/platform-sdk');\nconst getServerlessFilePath = require('./getServerlessFilePath');\nconst simpleGit = require('simple-git/promise');\nconst { version: packageJsonVersion } = require('../../package');\n\nconst git = simpleGit();\ngit.silent(true);\n\n/*\n * Parse Deployment Data\n * - Takes data from the Framework and formats it into our data model\n */\n\nconst parseDeploymentData = async (ctx, status = 'success', error = null, archived = false) => {\n  const { service } = ctx.sls;\n  const deployment = new SDK.Deployment();\n\n  const accountId = await ctx.provider.getAccountId();\n  const serverlessFileName = await getServerlessFilePath(\n    ctx.sls.processedInput.options.config,\n    ctx.sls.config.servicePath\n  );\n  const serverlessFile = (await fs.readFile(serverlessFileName)).toString();\n  /*\n   * Add deployment data...\n   */\n\n  if (!archived) {\n    const cfnStack = await (async () => {\n      try {\n        return await ctx.provider.request('CloudFormation', 'describeStacks', {\n          StackName: ctx.provider.naming.getStackName(),\n        });\n      } catch (requestError) {\n        const { providerError } = requestError;\n        if (providerError) {\n          // 400 means stack was not deployed yet (first deployment failed)\n          if (providerError.statusCode === 400) return null;\n        }\n\n        throw requestError;\n      }\n    })();\n\n    let logsRoleArn;\n    if (\n      ctx.sls.service.custom &&\n      ctx.sls.service.custom.enterprise &&\n      ctx.sls.service.custom.enterprise.logAccessIamRole\n    ) {\n      logsRoleArn = ctx.sls.service.custom.enterprise.logAccessIamRole;\n    } else {\n      // get log access role info\n      const logsRole =\n        cfnStack &&\n        _.find(\n          cfnStack.Stacks[0].Outputs,\n          ({ OutputKey }) => OutputKey === 'EnterpriseLogAccessIamRole'\n        );\n      logsRoleArn = logsRole && logsRole.OutputValue;\n    }\n    let logIngestMode = 'push';\n    if (\n      ctx.sls.service.custom &&\n      ctx.sls.service.custom.enterprise &&\n      ctx.sls.service.custom.enterprise.logIngestMode\n    ) {\n      logIngestMode = 'pull';\n    }\n\n    // get any CFN outputs\n    const outputs = service.outputs || {};\n    for (const [outputKey, outputValue] of _.entries(outputs)) {\n      if (typeof outputValue === 'string' && outputValue.startsWith('CFN!?')) {\n        if (cfnStack) {\n          const cfnOutput = _.find(\n            cfnStack.Stacks[0].Outputs,\n            ({ OutputKey }) => OutputKey === `${outputValue.slice(5)}`\n          );\n          outputs[outputKey] = cfnOutput.OutputValue;\n        } else {\n          delete outputs[outputKey];\n        }\n      }\n    }\n\n    deployment.set({\n      buildId: process.env.SERVERLESS_BUILD_ID || process.env.SLS_BUILD_ID,\n      serverlessFile,\n      serverlessFileName,\n      versionFramework: ctx.sls.version,\n      versionEnterprisePlugin: packageJsonVersion,\n      tenantUid: service.orgUid,\n      appUid: service.appUid,\n      tenantName: service.org,\n      appName: service.app,\n      serviceName: service.service,\n      stageName: ctx.provider.getStage(),\n      regionName: ctx.provider.getRegion(),\n      deploymentUid: ctx.deploymentUid,\n      logsRoleArn,\n      archived,\n      status,\n      provider: {\n        type: 'aws',\n        aws: { accountId },\n        // environment: Object.keys(service.provider.environment || {})\n      },\n      layers: service.layers || {},\n      plugins: service.plugins ? service.plugins.modules || service.plugins : [],\n      custom: service.custom || {},\n      safeguards: ctx.state.safeguardsResults,\n      secrets: Array.from(ctx.state.secretsUsed),\n      outputs,\n      error,\n      logIngestMode,\n    });\n\n    const vcs = { type: null };\n    // Add VCS info\n    if (process.env.SERVERLESS_CI_CD === 'true') {\n      Object.assign(vcs, {\n        type: 'git',\n        repository: process.env.SERVERLESS_REPO,\n        branch: process.env.SERVERLESS_BRANCH,\n        pullRequest: process.env.SERVERLESS_PULL_REQUEST,\n        committer: process.env.SERVERLESS_COMMIT_USER,\n        commit: process.env.SERVERLESS_COMMIT_SHA,\n        commitMessage: process.env.SERVERLESS_COMMIT_MSG,\n        deployType: process.env.SERVERLESS_DEPLOY_TYPE,\n        relativePath: process.env.SERVERLESS_ROOT_PATH,\n      });\n    } else {\n      try {\n        const isGit = await git.checkIsRepo();\n        if (isGit) {\n          vcs.type = 'git';\n        }\n      } catch (err) {\n        // pass\n      }\n      if (vcs.type === 'git') {\n        const branch = await git.branch();\n        if (branch.current) {\n          let origin = await git.raw(['config', `branch.${branch.current}.remote`]);\n          if (origin) {\n            origin = origin.trim();\n            const remotes = await git.getRemotes();\n            const originRemote = remotes.filter(({ name }) => name === origin)[0];\n            if (originRemote) vcs.originUrl = originRemote.refs.fetch;\n          }\n          vcs.branch = branch.current;\n        }\n        try {\n          vcs.commit = (await git.raw(['show', '-s', '--format=%H', branch.current || ''])).trim();\n        } catch (gitShowError) {\n          // Most likely a fresh repo (no commits)\n          if (!gitShowError.message.includes('fatal:')) throw gitShowError;\n        }\n        if (vcs.commit) {\n          vcs.commitMessage = (\n            await git.raw(['show', '-s', '--format=%B', branch.current || ''])\n          ).trim();\n          vcs.committerEmail = (\n            await git.raw(['show', '-s', '--format=%ae', branch.current || ''])\n          ).trim();\n        }\n        vcs.relativePath = (await git.raw(['rev-parse', '--show-prefix'])).trim();\n      }\n    }\n    deployment.set({ vcs });\n\n    /*\n     * Add this deployment's functions...\n     */\n\n    for (const fnName of Object.keys(service.functions)) {\n      const fn = service.functions[fnName];\n      const deployedFunctionName =\n        fn.name || `${service.service}-${ctx.provider.getStage()}-${fnName}`;\n      fn.events = fn.events || [];\n\n      // Function\n      deployment.setFunction({\n        name: deployedFunctionName,\n        description: fn.description || null,\n        timeout: fn.timeout,\n        type: 'awsLambda',\n        arn: `arn:aws:lambda:${ctx.provider.getRegion()}:${accountId}:function:${deployedFunctionName}`,\n        custom: {\n          handler: fn.handler,\n          memorySize: fn.memory,\n          runtime: fn.runtime,\n          environment: Object.keys(fn.environment || {}),\n          role: fn.role,\n          onError: fn.onError,\n          awsKmsKeyArn: fn.awsKmsKeyArn,\n          tags: fn.tags || {},\n          vpc: fn.vpc || {},\n          layers: fn.layers || [],\n          name: fn.name || fnName,\n        },\n      });\n\n      /*\n       * Add this functions's subscriptions...\n       */\n\n      for (const sub of fn.events) {\n        let subDetails = {};\n        let type;\n        if (typeof sub === 'string') {\n          type = sub;\n        } else {\n          type = Object.keys(sub)[0];\n          if ((type === 'http' || type === 'httpApi') && cfnStack) {\n            const apigResource = _.find(\n              cfnStack.Stacks[0].Outputs,\n              ({ OutputKey }) =>\n                !OutputKey.endsWith('Websocket') &&\n                OutputKey.match(ctx.provider.naming.getServiceEndpointRegex())\n            );\n            const apiId =\n              apigResource && apigResource.OutputValue.split('https://')[1].split('.')[0];\n\n            if (typeof sub[type] === 'string') {\n              subDetails = {\n                path: sub[type].split(' ')[1],\n                method: sub[type].split(' ')[0],\n              };\n            } else {\n              subDetails = {\n                path: sub[type].path,\n                method: sub[type].method,\n                cors: sub[type].cors,\n                integration: sub[type].integration,\n                authorizer: sub[type].authorizer,\n                timeout: sub[type].timeout,\n              };\n            }\n            if (type === 'http') {\n              subDetails.restApiId = apiId;\n            } else {\n              subDetails.httpApiId = apiId;\n            }\n          } else if (sub[type] instanceof Object) {\n            Object.assign(subDetails, sub[type]);\n          } else {\n            Object.assign(subDetails, { [type]: sub[type] });\n          }\n          if (type === 'websocket' && cfnStack) {\n            const apigResource = _.find(\n              cfnStack.Stacks[0].Outputs,\n              ({ OutputKey }) =>\n                OutputKey.endsWith('Websocket') &&\n                OutputKey.match(ctx.provider.naming.getServiceEndpointRegex())\n            );\n            const apiId = apigResource && apigResource.OutputValue.split('wss://')[1].split('.')[0];\n            subDetails.websocketApiId = apiId;\n          }\n        }\n\n        deployment.setSubscription({ type, function: deployedFunctionName, ...subDetails });\n      }\n    }\n  } else {\n    const vcs = {};\n    if (process.env.SERVERLESS_CI_CD === 'true') {\n      Object.assign(vcs, {\n        type: 'git',\n        repository: process.env.SERVERLESS_REPO,\n        branch: process.env.SERVERLESS_BRANCH,\n        pullRequest: process.env.SERVERLESS_PULL_REQUEST,\n        committer: process.env.SERVERLESS_COMMIT_USER,\n        commit: process.env.SERVERLESS_COMMIT_SHA,\n        commitMessage: process.env.SERVERLESS_COMMIT_MSG,\n        deployType: process.env.SERVERLESS_DEPLOY_TYPE,\n        relativePath: process.env.SERVERLESS_ROOT_PATH,\n      });\n    }\n    deployment.set({\n      buildId: process.env.SERVERLESS_BUILD_ID || process.env.SLS_BUILD_ID,\n      versionFramework: ctx.sls.version,\n      versionEnterprisePlugin: packageJsonVersion,\n      tenantUid: service.orgUid,\n      appUid: service.appUid,\n      tenantName: service.org,\n      appName: service.app,\n      serviceName: service.service,\n      stageName: ctx.provider.getStage(),\n      regionName: ctx.provider.getRegion(),\n      archived,\n      status,\n      secrets: Array.from(ctx.state.secretsUsed),\n      error,\n      vcs,\n    });\n  }\n\n  return deployment;\n};\n\nmodule.exports = parseDeploymentData;\n"],"file":"parse.js"}